# OSIV

## Open Session In View
Hibernate 에서는 entity manager 대신에 session 이라는 말을 쓴다. 그래서 session 이라는 이름이 붙었다고 하는데, jpa에서는
application.yml(설정파일) 에서 open-in-view=true(false)로 설정할 수 있다.
기본값은 true 이다.
즉 영속성 컨텍스트를 뷰까지 열어두는 기능인데, 이 영속성 컨텍스트가 뷰까지 살아있다면 뷰에서도 지연로딩을 할 수가 있게 된다.

## 동작원리
- 클라이언트의 요청이 들어오면 영속성 컨텍스트 생성
- 영속성 컨텍스트를 찾아와서 Service 계층에서 Transaction 시작
- 트랜잭션 커밋, 영속성 컨텍스트 플러시(종료는 아님)
- 서블릿 필터, 스프링 인터셉터로 요청 다시 들어오면, 영속성 컨텍스트 종료
- 트랜잭션 범위 밖인 컨트롤러와 뷰에서는 변경감지에 의한 데이터 수정이 일어나지 않는다.

## 주의사항
최초 데이터베이스 커넥션 시작 시점부터 API 응답이 끝나고 반환할 때까지, 영속성 컨텍스트와 데이터 커넥션을 유지한다.
그래서 데이터 베이스 커넥션 리소스를 너무 오랫동안 사용하여, 실시간 트래픽이 몰리는 서비스에서 커넥션이 모자라 장애가 날 수 있다.(영속성 컨텍스트와 db 커넥션은 1:1 관계)
이 같은 경우 osiv 옵션을 false 로 하는 것도 고려해야 하는데, 이럴 때는 @Transactional 안에서 지연로딩이 발생하는 쿼리 호출이 이루어 져야 한다.
즉 명확한 비즈니스 로직을 담고 있는 Service 클래스와 화면이나 API에 맞춘 서비스를 구현하는 AppService 등을 분리하는 것이 유지보수에 유리할 것이다.